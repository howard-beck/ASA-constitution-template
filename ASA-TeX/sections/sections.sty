\makearr{sectionnames}
\makearr{sectionshorts}
\makearr{sectionlongs}
\makearr{sectionnumstyles}

\RequirePackage{./ASA-TeX/sections/labeling}
\RequirePackage{./ASA-TeX/sections/sections_aux}
\RequirePackage{./ASA-TeX/sections/enumitems}


\newcommand{\getdepth}[1]{%
    \expandafter\csname #1depth\endcsname%
}
\newcommand{\getindex}[1]{%
    \expandafter\csname #1index\endcsname%
}


\makearr{SectToTheoDepth}
\newcounter{sectiondepth}
\setcounter{sectiondepth}{-1}

\makearr{SectToSectType}
\makearr{SectToSectNum}




\newcounter{lastdepth}
\setcounter{lastdepth}{-1}

\edef\lastTheoDepth{-1}
\edef\lastIndex{-2}


\newcounter{headercounter}
\setcounter{headercounter}{-1}


\NewDocumentCommand{\makesectioning}{ m m m m O{} O{1} }{
    % name: 1
    % short: 2
    % full: 3
    % number type: #4
    % depth: #5
    % counter within previous: #6
    %
    \edef\nextdepth{\the\numexpr1+\thelastdepth\relax}%
    \ifstrempty{#5}{%
    }{%
        \edef\nextdepth{#5}%
    }%
    \expandafter\edef\csname #1depth\endcsname{\nextdepth}%
    \setcounter{lastdepth}{\nextdepth}%
    %
    %
    \@makeLabelable{#1}{#2}{#3}{#6}
    \expandafter\let\csname#1numstyle\endcsname#4
    %
    %
    \let\commandname\RenewDocumentCommand
    \@ifundefined{#1}{
        \let\commandname\NewDocumentCommand
    }{}
    \ExpandArgs{c}\commandname{#1}{s m}{%
        \ifnum\@makingTOC=1
            \old@section*{##2}
        \else
            \setcounter{enumi}{0}
            \edef\TheoDepth{\getdepth{#1}}%
            %
            \ifnum\thesectiondepth>-1
                \ifnum\TheoDepth>\the\numexpr1+\lastTheoDepth\relax
                    \PackageError{commands}{Cannot use #1, please use section headers sequentially}{}%
                \fi%
            \fi
            %
            \ifnum\lastIndex<\getindex{#1}%
                \stepcounter{sectiondepth}%
            \else%
                \edef\@newdepth{\the\numexpr\thesectiondepth+\getindex{#1}-\lastIndex}%
                \ifnum\@newdepth<0
                    \edef\@newdepth{0}
                \fi
                \setcounter{sectiondepth}{\@newdepth}
            \fi%
            %
            \edef\lastTheoDepth{\TheoDepth}
            \edef\lastIndex{\getindex{#1}}
            \setidx\SectToTheoDepth{\thesectiondepth}{\TheoDepth}%
            %
            \stepcounter{#1}%
            \setidx\SectToSectType{\thesectiondepth}{#1}%
            \setidx\SectToSectNum{\thesectiondepth}{#4{#1}}%
            %
            \def\oldtotal{\getidx\@sectionTotals{\csname#1index\endcsname}}
            \setidx\@sectionTotals{\csname#1index\endcsname}{\the\numexpr\oldtotal+1\relax}
            %
            \def\spacingamount{\fpeval{1/(2^\TheoDepth)}}%
            \ifnum\thesectiondepth=0%
                \vspace{1cm}
                %\hrule
            \fi%
            \par%
            \vspace{\spacingamount cm}%
            %
            %%% TEXT HERE
            \phantomsection%
            \def\sectionstyling{DEFAULTSECTIONSTYLE}%
            \ifnum\thesectiondepth<\getlen{\SectionStyling}%
                \def\sectionstyling{\getidx\SectionStyling{\thesectiondepth}}%
            \fi%
            %
            \stepcounter{headercounter}%
            \sectheadid[@sectheaddestlabel]%
            \hyperref[\@sectheaddestlabel]{\csname \sectionstyling\endcsname{\textsc{#3 #4{#1}. ##2}}}%
            \protected@write\SECTIONINFO{}{\string%
                \declareHeaderAtCount{\theheadercounter}{#1}{#4{#1}}{\thesectiondepth}%
            }%
            \edef\@currentlabel{\sectheadfullname{\theheadercounter}}%
            \label{\@sectheaddestlabel}%
            %
            \reversemarginpar\marginpar[%
                \begin{spacing}{1}%
                    \scriptsize \sectheadabbv%
                \end{spacing}%
            ]{}%
            %
            \par
            %
            \IfBooleanTF{##1}%
            {}%
            {%
                \ifnum\thesectiondepth<\getlen{\ToCDepths}%
                    \addcontentsline{toc}{\getidx\ToCDepths{\thesectiondepth}}{#3 #4{#1}. ##2}%
                \fi%
            }%
        \fi%
    }%
}

\makearr{ToCDepths}
\makearr{SectionStyling}

\addidx\ToCDepths{section}
\def\SECTIONSTYLE{\normalfont\Large\bfseries\underline}
\addidx\SectionStyling{SECTIONSTYLE}

\addidx\ToCDepths{subsection}
\def\SUBSECTIONSTYLE{\normalfont\large\bfseries}
\addidx\SectionStyling{SUBSECTIONSTYLE}

\addidx\ToCDepths{subsubsection}
\def\DEFAULTSECTIONSTYLE{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{paragraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{subparagraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}



\make@enums{}

\let\appnum\Alph
\makesectioning{appendix}{APP}{Appendix}{\appnum}[0][0]

\let\artnum\Roman
\makesectioning{article}{ART}{Article}{\artnum}[\thelastdepth]

\let\secnum\arabic
\makesectioning{section}{SEC}{Section}{\secnum}

\let\subnum\arabic
\makesectioning{subsection}{SUB}{Subsection}{\subnum}

\let\subsubnum\arabic
\makesectioning{subsubsection}{SUB$^2$}{Subsubsection}{\subsubnum}