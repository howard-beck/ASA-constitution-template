\makeatletter

\makearr{sectionnames}
\makearr{sectionshorts}
\makearr{sectionlongs}
\makearr{sectionnumstyles}

\newcommand{\getdepth}[1]{%
    \expandafter\csname #1depth\endcsname%
}
\newcommand{\getindex}[1]{%
    \expandafter\csname #1index\endcsname%
}


\makearr{SectToTheoDepth}
\newcounter{sectiondepth}
\setcounter{sectiondepth}{-1}

\makearr{SectToSectType}
\makearr{SectToSectNum}



\newcounter{sectheadnameiter}
\newcounter{dummysectheadcounter}
\setcounter{dummysectheadcounter}{-1}%
\NewDocumentCommand{\sectheadname}{m m O{} O{0}}{%
    % #1:
    %    1 = full
    %    2 = short
    %    3 = ID
    % #2: step
    % #3: variable to encode into
    % #4: trim at start?
    \edef\returntext{}%
    \ifnum\getlen{\SectDepthsAtCount}<\the\numexpr1+#2\relax%
        % do nothing
    \else
        \edef\ThisDepth{\getidx\SectDepthsAtCount{#2}}%
        \edef\ThisSectToSectType{\expandafter\csname SectToSectTypeAtCount#2\endcsname}%
        \edef\ThisSectToSectNum{\expandafter\csname SectToSectNumAtCount#2\endcsname}%
        \edef\ThisSectionTotalsHistory{\expandafter\csname @sectionTotalsHistoryAtCount#2\endcsname}%
        %
        \edef\SectTreeAgree{0}%
        \ifnum#4=1%
            \edef\SectTreeAgree{1}%
        \fi%
        \setcounter{dummysectheadcounter}{0}%
        %
        \forloop{sectheadnameiter}{0}{\value{sectheadnameiter} < \the\numexpr1+\ThisDepth\relax}{%
            \edef\numbr{\getidx\ThisSectToSectNum{\thesectheadnameiter}}%
            \edef\currentnumbr{\getidx\SectToSectNum{\thesectheadnameiter}}%
            %
            \edef\secttypeID{\getidx\ThisSectToSectType{\thesectheadnameiter}}%
            \edef\indexofsecttype{\getindex{\secttypeID}}%
            %
            %
            \ifnum#4=1%
                \edef\@thisSectionTotal{\getidx\ThisSectionTotalsHistory{\indexofsecttype}}%
                \edef\@currentSectionTotal{\getidx\@sectionTotals{\indexofsecttype}}%
                %
                \ifnum\@thisSectionTotal=\@currentSectionTotal%
                \else%
                    \edef\SectTreeAgree{0}%
                \fi%
            \fi%
            %
            \ifnum\SectTreeAgree=0%
                \ifnum\thedummysectheadcounter>0%
                    \ifnum#1=1%
                        \edef\returntext{\returntext, }%
                    \else%
                        \ifnum#1=2%
                            \edef\returntext{\returntext\\}%
                        \else%
                            \edef\returntext{\returntext.}%
                        \fi%
                    \fi%
                \else%
                    \edef\returntext{}%
                \fi%
                %
                \let\seclist\sectionshorts%
                \def\secspec{.}%
                \ifnum#1=1%
                    \let\seclist\sectionlongs%
                    \def\secspec{ }%
                \fi%
                \edef\secttypename{\getidx\seclist{\indexofsecttype}}%
                \edef\returntext{\returntext\secttypename\secspec\numbr}%
                %
                \stepcounter{dummysectheadcounter}%
            \fi%
        }%
    \fi%
    %
    \ifstrempty{#3}%
    {%
        \returntext%
    }%
    {%
        \expandafter\let\csname#3\endcsname\returntext%
    }%
    \setcounter{dummysectheadcounter}{-1}%
}
\NewDocumentCommand{\sectheadfullname}{m O{}}{%
    \sectheadname{1}{#1}[#2][\MakeCompactRefs]%
}
\NewDocumentCommand{\sectheadabbv}{O{}}{%
    \sectheadname{2}{\theheadercounter}[#1][0]%
}
\NewDocumentCommand{\sectheadid}{O{}}{%
    \sectheadname{3}{\theheadercounter}[#1][0]%
}


\newcounter{lastdepth}
\setcounter{lastdepth}{-1}

\edef\lastTheoDepth{-1}
\edef\lastIndex{-2}


\newcounter{headercounter}
\setcounter{headercounter}{-1}


\makearr{SectToSectTypeHistory}
\makearr{SectToSectNumHistory}
\makearr{SectDepthHistory}
\makearr{SectDepthsAtCount}

\makearr{@apriori@section@names}

\makearr{@sectionTotalsHistory}
\def\@madeSections{0}
\newcommand{\@makeFutureSection}[1]{
    \addidx\@apriori@section@names{#1}
    \addidx\@sectionTotalsHistory{0}

    \expandafter\edef\csname#1index\endcsname{\getlen{\sectionnames}}%
    \addidx\sectionnames{#1}%
    \def\@madeSections{1}
}

\newcounter{dummydummy}
\newcommand{\declareHeaderAtCount}[4]{%
    \typeout{Header info [#1]: #2.#3 at #4}
    % headercounter #1
    % SectType #2
    % SectNum #3
    % depth #4
    \setidx\SectToSectTypeHistory{#4}{#2}%
    \setidx\SectToSectNumHistory{#4}{#3}%
    %\addidx\
    %
    \copyarr\SectToSectTypeHistory{SectToSectTypeAtCount#1}%
    \copyarr\SectToSectNumHistory{SectToSectNumAtCount#1}%
    \setidx\SectDepthsAtCount{#1}{#4}%
    %
    \expandafter\let\expandafter\sectionIndex\csname#2index\endcsname
    \edef\oldtotal{\getidx\@sectionTotalsHistory{\sectionIndex}}
    \setidx\@sectionTotalsHistory{\sectionIndex}{\the\numexpr\oldtotal+1\relax}
    \copyarr\@sectionTotalsHistory{@sectionTotalsHistoryAtCount#1}%
}


\IfFileExists{\jobname-sections.aux}{
    \import{./}{\jobname-sections.aux}
}{}
\newwrite\SECTIONINFO
\immediate\openout\SECTIONINFO=\jobname-sections.aux

\makearr{@sectionTotals}
\NewDocumentCommand{\makesectioning}{ m m m m O{} }{
    % name: 1
    % short: 2
    % full: 3
    % number type: #4
    % depth: #5
    %
    \edef\nextdepth{\the\numexpr1+\thelastdepth\relax}%
    \ifstrempty{#5}{%
    }{%
        \edef\nextdepth{#5}%
    }%
    \expandafter\edef\csname #1depth\endcsname{\nextdepth}%
    \setcounter{lastdepth}{\nextdepth}%
    %
    \ifnum\@madeSections=0
        \expandafter\edef\csname#1index\endcsname{\getlen{\sectionnames}}%
    \fi
    \addidx\@sectionTotals{0}
    %
    %
    \let\commandname\RenewDocumentCommand
    \@ifundefined{#1}{
        \let\commandname\NewDocumentCommand
    }{}
    \ExpandArgs{c}\commandname{#1}{s m}{%
        \ifnum\@makingTOC=1
            \old@section*{##2}
        \else
            \setcounter{enumi}{0}
            \edef\TheoDepth{\getdepth{#1}}%
            %
            \ifnum\thesectiondepth>-1
                \ifnum\TheoDepth>\the\numexpr1+\lastTheoDepth\relax
                    \PackageError{commands}{Cannot use #1, please use section headers sequentially}{}%
                \fi%
            \fi
            %
            \ifnum\lastIndex<\getindex{#1}%
                \stepcounter{sectiondepth}%
            \else%
                \edef\@newdepth{\the\numexpr\thesectiondepth+\getindex{#1}-\lastIndex}%
                \ifnum\@newdepth<0
                    \edef\@newdepth{0}
                \fi
                \setcounter{sectiondepth}{\@newdepth}
            \fi%
            %
            \edef\lastTheoDepth{\TheoDepth}
            \edef\lastIndex{\getindex{#1}}
            \setidx\SectToTheoDepth{\thesectiondepth}{\TheoDepth}%
            %
            \stepcounter{#1}%
            \setidx\SectToSectType{\thesectiondepth}{#1}%
            \setidx\SectToSectNum{\thesectiondepth}{#4{#1}}%
            %
            \def\oldtotal{\getidx\@sectionTotals{\csname#1index\endcsname}}
            \setidx\@sectionTotals{\csname#1index\endcsname}{\the\numexpr\oldtotal+1\relax}
            %
            \stepcounter{headercounter}%
            %
            \protected@write\SECTIONINFO{}{\string%
                \declareHeaderAtCount{\theheadercounter}{#1}{#4{#1}}{\thesectiondepth}%
            }
            %
            \def\spacingamount{\fpeval{1/(2^\TheoDepth)}}%
            \ifnum\thesectiondepth=0%
                \vspace{1cm}
                %\hrule
            \fi%
            \par%
            \vspace{\spacingamount cm}%
            %
            %%% TEXT HERE
            \phantomsection%
            \def\sectionstyling{DEFAULTSECTIONSTYLE}%
            \ifnum\thesectiondepth<\getlen{\SectionStyling}%
                \def\sectionstyling{\getidx\SectionStyling{\thesectiondepth}}%
            \fi%
            %
            \sectheadid[@sectheaddestlabel]%
            \hyperref[\@sectheaddestlabel]{\csname \sectionstyling\endcsname{\textsc{#3 #4{#1}. ##2}}}%
            %
            \reversemarginpar\marginpar[%
                \begin{spacing}{1}%
                    \scriptsize \sectheadabbv%
                \end{spacing}%
            ]{}%
            \edef\@currentlabel{\sectheadfullname{\theheadercounter}}%
            \label{\@sectheaddestlabel}%
            \par
            %
            \IfBooleanTF{##1}%
            {}%
            {%
                \ifnum\thesectiondepth<\getlen{\ToCDepths}%
                    \addcontentsline{toc}{\getidx\ToCDepths{\thesectiondepth}}{#3 #4{#1}. ##2}%
                \fi%
            }%
        \fi%
    }%
    %
    \ifnum\@madeSections=0
        \def\numsectypes{\getlen{\sectionnames}}%
    \else
        \expandafter\def\expandafter\numsectypes{\csname#1index\endcsname}
    \fi
    \@ifundefined{the#1}{
        \newcounter{#1}%
    }{
        \setcounter{#1}{0}
    }
    \ifnum\numsectypes>0%
        \edef\lastsecnum{\the\numexpr\numsectypes - 1\relax}%
        \counterwithin*{#1}{\getidx\sectionnames{\lastsecnum}}%
    \fi%
    %
    \ifnum\@madeSections=0
        \typeout{no made section!}
        \addidx\sectionnames{#1}%
    \else
        \typeout{section made!}
    \fi
    
    \addidx\sectionshorts{#2}%
    \addidx\sectionlongs{#3}%
    \expandafter\let\csname#1numstyle\endcsname#4
    \protected@write\SECTIONINFO{}{\string%
        \@makeFutureSection{#1}%
    }%
}

\makearr{ToCDepths}
\makearr{SectionStyling}

\addidx\ToCDepths{section}
\def\SECTIONSTYLE{\normalfont\Large\bfseries\underline}
\addidx\SectionStyling{SECTIONSTYLE}

\addidx\ToCDepths{subsection}
\def\SUBSECTIONSTYLE{\normalfont\large\bfseries}
\addidx\SectionStyling{SUBSECTIONSTYLE}

\addidx\ToCDepths{subsubsection}
\def\DEFAULTSECTIONSTYLE{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{paragraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{subparagraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}



\let\appnum\Alph
\makesectioning{appendix}{APP}{Appendix}{\appnum}

\let\artnum\Roman
\makesectioning{article}{ART}{Article}{\artnum}[\thelastdepth]

\let\secnum\arabic
\makesectioning{section}{SEC}{Section}{\secnum}

\let\subnum\arabic
\makesectioning{subsection}{SUB}{Subsection}{\subnum}

\let\subsubnum\arabic
\makesectioning{subsubsection}{SUB$^2$}{Subsubsection}{\subsubnum}





\NewCommandCopy\@old@enumerate\enumerate
\NewCommandCopy\@old@endenumerate\endenumerate
\renewenvironment{enumerate}[1][]%
{%
    \ifnum\@enumdepth=0%
        \ifnum\theenumi=0%
            \@old@enumerate[#1]%
        \else%
            \ifstrempty{#1}%
            {%
                \@old@enumerate[resume]%
            }%
            {%
                \@old@enumerate[#1,resume]%
            }%
        \fi%
    \else%
        \@old@enumerate[#1]%
    \fi%
}%
{%
    \@old@endenumerate%
}
\newcommand{\@itemRef}{
    \edef\starttext{Item }
}

\let\@old@item\item
\newcounter{@itemLabelCounter}
\def\item{
    \@old@item
    \def\@itemLabelStr{}
    \def\@itemNameStr{}
    \ifnum\the\@enumdepth>0%
        \forloop{@itemLabelCounter}{1}{\value{@itemLabelCounter} < \the\numexpr1+\@enumdepth\relax}{%
            \ifnum\the@itemLabelCounter>1%
                \edef\@itemLabelStr{\@itemLabelStr.}
            \fi%
            \edef\@itemLabelStr{\@itemLabelStr\arabic{enum\romannumeral\the@itemLabelCounter}}%
            \edef\@itemName{\csname labelenum\romannumeral\the@itemLabelCounter\endcsname}
            \edef\@itemNameStr{\@itemNameStr\@itemName}%
        }%
        \sectheadid[@itemLabel]%
        \edef\@currentlabel{\sectheadfullname{\theheadercounter}, Item \@itemNameStr}%
        \label{\@itemLabel.ITEM.\@itemLabelStr}
    \fi%
}

\iffalse
\NewDocumentCommand{\@itemName}{m m O{} O{0}}{%
    % #1:
    %    1 = text
    %    2 = ID
    % #2: step
    % #3: variable to encode into
    % #4: trim at start?
    \edef\returntext{\sectheadname}%
    \ifnum\getlen{\SectDepthsAtCount}<\the\numexpr1+#2\relax%
        % do nothing
    \else
        \edef\ThisDepth{\getidx\SectDepthsAtCount{#2}}%
        \edef\ThisSectToSectType{\expandafter\csname SectToSectTypeAtCount#2\endcsname}%
        \edef\ThisSectToSectNum{\expandafter\csname SectToSectNumAtCount#2\endcsname}%
        \edef\ThisSectionTotalsHistory{\expandafter\csname @sectionTotalsHistoryAtCount#2\endcsname}%
        %
        \edef\SectTreeAgree{0}%
        \ifnum#4=1%
            \edef\SectTreeAgree{1}%
        \fi%
        \setcounter{dummysectheadcounter}{0}%
        %
        \forloop{sectheadnameiter}{0}{\value{sectheadnameiter} < \the\numexpr1+\ThisDepth\relax}{%
            \edef\numbr{\getidx\ThisSectToSectNum{\thesectheadnameiter}}%
            \edef\currentnumbr{\getidx\SectToSectNum{\thesectheadnameiter}}%
            %
            \edef\secttypeID{\getidx\ThisSectToSectType{\thesectheadnameiter}}%
            \edef\indexofsecttype{\getindex{\secttypeID}}%
            %
            %
            \ifnum#4=1%
                \edef\@thisSectionTotal{\getidx\ThisSectionTotalsHistory{\indexofsecttype}}%
                \edef\@currentSectionTotal{\getidx\@sectionTotals{\indexofsecttype}}%
                %
                \ifnum\@thisSectionTotal=\@currentSectionTotal%
                \else%
                    \edef\SectTreeAgree{0}%
                \fi%
            \fi%
            %
            \ifnum\SectTreeAgree=0%
                \ifnum\thedummysectheadcounter>0%
                    \ifnum#1=1%
                        \edef\returntext{\returntext, }%
                    \else%
                        \ifnum#1=2%
                            \edef\returntext{\returntext\\}%
                        \else%
                            \edef\returntext{\returntext.}%
                        \fi%
                    \fi%
                \else%
                    \edef\returntext{}%
                \fi%
                %
                \let\seclist\sectionshorts%
                \def\secspec{.}%
                \ifnum#1=1%
                    \let\seclist\sectionlongs%
                    \def\secspec{ }%
                \fi%
                \edef\secttypename{\getidx\seclist{\indexofsecttype}}%
                \edef\returntext{\returntext\secttypename\secspec\numbr}%
                %
                \stepcounter{dummysectheadcounter}%
            \fi%
        }%
    \fi%
    %
    \ifstrempty{#3}%
    {%
        \returntext%
    }%
    {%
        \expandafter\let\csname#3\endcsname\returntext%
    }%
    \setcounter{dummysectheadcounter}{-1}%
}
\NewDocumentCommand{\sectheadfullname}{m O{}}{%
    \sectheadname{1}{#1}[#2][\MakeCompactRefs]%
}
\NewDocumentCommand{\sectheadabbv}{O{}}{%
    \sectheadname{2}{\theheadercounter}[#1][0]%
}
\NewDocumentCommand{\sectheadid}{O{}}{%
    \sectheadname{3}{\theheadercounter}[#1][0]%
}
\fi


\makeatother