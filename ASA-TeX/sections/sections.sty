\newbool{sectionlinebreak}
\newbool{headerfullinfo}
\def\headerfullinfo{margin}

\makearr{sectionnames}
\makearr{sectionshorts}
\makearr{sectionlongs}
\makearr{sectionnumstyles}

\RequirePackage{./ASA-TeX/sections/labeling}
\RequirePackage{./ASA-TeX/sections/sections_aux}
\RequirePackage{./ASA-TeX/sections/enumitems}


\newcommand{\getdepth}[1]{%
    \expandafter\csname #1depth\endcsname%
}
\newcommand{\getindex}[1]{%
    \expandafter\csname #1index\endcsname%
}


\makearr{SectToTheoDepth}
\newcounter{sectiondepth}
\setcounter{sectiondepth}{-1}
\newcounter{sectiondepth@noitems}
\setcounter{sectiondepth@noitems}{-1}

\makearr{SectToSectType}
\makearr{SectToSectNum}




\newcounter{lastdepth}
\setcounter{lastdepth}{-1}

\edef\lastTheoDepth{-1}
\edef\lastIndex{-2}


\newcounter{headercounter}
\setcounter{headercounter}{-1}

\newlength{\sectionheaderheight}
\newlength{\sectionIDheight}

\NewDocumentCommand{\makesectioning}{ m m m O{} O{1} }{
    % name: 1
    % short: 2
    % full: 3
    % depth: #4
    % counter within previous: #5
    %
    \edef\nextdepth{\the\numexpr1+\thelastdepth\relax}%
    \ifstrempty{#4}{%
    }{%
        \edef\nextdepth{#4}%
    }%
    \expandafter\edef\csname #1depth\endcsname{\nextdepth}%
    \setcounter{lastdepth}{\nextdepth}%
    %
    %
    \@makeLabelable{#1}{#2}{#3}{#5}
    \@ifundefined{#1numstyle}%
    {
        \expandafter\let\csname#1numstyle\endcsname\defaultnumstyle
    }
    {}
    %
    %
    \let\commandname\RenewDocumentCommand
    \@ifundefined{#1}{
        \let\commandname\NewDocumentCommand
    }{}
    
    \expandafter\def\csname#1pre \endcsname{}
    \expandafter\def\csname#1post \endcsname{}

    \ExpandArgs{c}\commandname{#1}{s m}{%
        \typeout{#1 section title ##2}
        \ifnum\@makingTOC=1
            \old@section*{##2}
        \else
            \setcounter{enumi}{0}
            \edef\TheoDepth{\getdepth{#1}}%
            %
            \ifnum\thesectiondepth>-1
                \ifnum\TheoDepth>\the\numexpr1+\lastTheoDepth\relax
                    \PackageError{commands}{Cannot use #1, please use section headers sequentially}{}%
                \fi%
            \fi
            %
            \ifnum\lastIndex<\getindex{#1}%
                \stepcounter{sectiondepth}%
            \else%
                \edef\@newdepth{\the\numexpr\thesectiondepth+\getindex{#1}-\lastIndex}%
                \ifnum\@newdepth<0%
                    \edef\@newdepth{0}%
                \fi%
                \setcounter{sectiondepth}{\@newdepth}%
                %
                \edef\@newdepth@noitems{\the\numexpr\thesectiondepth@noitems+\getindex{#1}-\lastIndex}%
                \ifnum\@newdepth@noitems<0%
                    \edef\@newdepth@noitems{0}%
                \fi%
                \setcounter{sectiondepth@noitems}{\@newdepth@noitems}%
            \fi%
            %
            \edef\lastTheoDepth{\TheoDepth}
            \edef\lastIndex{\getindex{#1}}
            \setidx\SectToTheoDepth{\thesectiondepth}{\TheoDepth}%
            %
            \stepcounter{#1}%
            \setidx\SectToSectType{\thesectiondepth}{#1}%
            \setidx\SectToSectNum{\thesectiondepth}{\csname#1numstyle\endcsname{#1}}%
            %
            \def\oldtotal{\getidx\@sectionTotals{\csname#1index\endcsname}}
            \setidx\@sectionTotals{\csname#1index\endcsname}{\the\numexpr\oldtotal+1\relax}
            %
            \def\spacingamount{\fpeval{1/(2^\TheoDepth)}}%
            \par%
            \vspace{\spacingamount cm}%
            %
            %%% TEXT HERE
            \@ifundefined{#1style}%
            {%
                \let\@sectionstyling\defaultstyle%
            }%
            {%
                \expandafter\let\expandafter\@sectionstyling\csname#1style\endcsname
            }%
            \@ifundefined{#1numstyle}%
            {%
                \let\@numstyling\defaultnumstyle%
            }%
            {%
                \expandafter\let\expandafter\@numstyling\csname#1numstyle\endcsname
            }%
            %
            \stepcounter{headercounter}%
            \sectheadid[@sectheaddestlabel]%
            \settoheight{\sectionheaderheight}{\@sectionstyling{o}}%
            \csname#1pre\endcsname
            \phantomsection%
            \hyperref[\@sectheaddestlabel]{\@sectionstyling{#3 \@numstyling{#1}. ##2}}%\afterheadertext%
            \csname#1post\endcsname
            \protected@write\SECTIONINFO{}{\string%
                \declareHeaderAtCount{\theheadercounter}{#1}{\@numstyling{#1}}{\thesectiondepth}%
            }%
            \edef\@currentlabel{\sectheadfullname{\theheadercounter}}%
            \label{\@sectheaddestlabel}%
            %
            \ifbool{headerfullinfo}%
            {%
                \settoheight{\sectionIDheight}{\headerfullinfosidestyle TESTING}%
                %
                \ifthenelse{\equal{\headerfullinfoside}{margin}}{%
                    \reversemarginpar\marginpar[%
                        \begin{spacing}{1}%    
                            \headerfullinfosidestyle \sectheadabbv%
                        \end{spacing}%
                    ]{}%
                }%
                {}%
                %
                \ifthenelse{\equal{\headerfullinfoside}{inline}}{%
                    \quad%
                    \raisebox%
                        {\dimexpr (\sectionheaderheight-\sectionIDheight)/2}%
                        {\headerfullinfosidestyle \sectheadid}%
                }%
                {}%
            }%
            {}%
            %
            \ifbool{sectionlinebreak}%
            {%
                \par%
            }%
            {}%
            %
            \IfBooleanTF{##1}%
            {}%
            {%
                \ifnum\thesectiondepth<\getlen{\ToCDepths}%
                    \addcontentsline{toc}{\getidx\ToCDepths{\thesectiondepth}}{#3 \@numstyling{#1}. ##2}%
                \fi%
            }%
        \fi%
    }%
}

\makearr{ToCDepths}
\addidx\ToCDepths{section}
\addidx\ToCDepths{subsection}
\addidx\ToCDepths{subsubsection}
\addidx\ToCDepths{paragraph}
\addidx\ToCDepths{subparagraph}



\make@enums{}

\makesectioning{appendix}{APP}{Appendix}[0][0]
\makesectioning{article}{ART}{Article}[\thelastdepth]
\makesectioning{section}{SEC}{Section}

\newcounter{@makeNsub@counter}
\newcommand{\makeNsubsection}[1]{
    \def\@subetc{}
    \def\@Subsubetc{Sub}
    \forloop{@makeNsub@counter}{0}{\value{@makeNsub@counter} < #1}{
        \edef\@subetc{\@subetc sub}
        \ifnum\the@makeNsub@counter>0
            \edef\@Subsubetc{\@Subsubetc sub}
        \fi
    }
    %\def\@subetc{\foreach \@n in {1, ..., #1}{sub}}
    \ifnum#1>1
        \def\@subExp{$^{#1}$}
    \else
        \def\@subExp{}
    \fi
    %\def\@Subsubetc{Sub\foreach \@n in {2, ..., #1}{sub}}

    \expandafter\let\csname @subetc#1\endcsname\@subetc
    \expandafter\let\csname @subExp#1\endcsname\@subExp
    \expandafter\let\csname @Subsubetc#1\endcsname\@Subsubetc

    \makesectioning{\csname @subetc#1\endcsname section}{SUB\csname @subExp#1\endcsname}{\csname @Subsubetc#1\endcsname section}
    %\typeout{\protect\makesectioning{\csname @subetc#1\endcsname section}{SUB\csname @subExp#1\endcsname}{\csname @Subsubetc#1\endcsname section}}
}
\makeNsubsection{1}
\makeNsubsection{2}
%\makesectioning{subsection}{SUB}{Subsection}
%\makesectioning{subsubsection}{SUB$^2$}{Subsubsection}




\newcommand{\officer}[1]{%
    \colorlet{defaultcolor}{.}
    \hyperref[officer:#1]{\textbf{\textcolor{defaultcolor}{#1}}}%
    \global\edef\@currentlabel{1}%
    \label{officer:#1}%
    \addcontentsline{toc}{\getidx\ToCDepths{\the\numexpr1+\thesectiondepth@noitems\relax}}{[Officer] #1}%
}