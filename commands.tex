%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                 Copyright Howard Beck @ 2024                      %
%                                                                   %
% Made for the Association of Student Activities (ASA) at the       %
% Massachusetts Institute of Technology (MIT).                      %
%                                                                   %
% Free for use by the ASA, ASA-recognized clubs, and                %
% collections of students at MIT trying to become an ASA-recognized %
% club (ASA Organizations).                                         %
%                                                                   %
% This software may not be published or distributed except by the   %
% copyright holder or by the executive board of the ASA.            %
%                                                                   %
% Further, do not sublicense and/or sell copies of the software,    %
% and do not employ it for commercial use.                          %
%                                                                   %
% Permission is granted to ASA organizations to freely modify       %
% any part of this code for their own use, as long as the copyright %
% notice here is kept in tact, and under the previous conditions.   %
%                                                                   %
% Permission is also granted to the executive board ASA to          %
% distribute modified copies of this code (subject to the above     %
% restrictions), that may contain different copyrights, so long as  %
% the following is included:                                        %
%    Based on code written by Howard Beck, MIT Class of 2025        %
%                                                                   %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% SETTINGS

%% Enable compact references
% Example: Inside of Article II, a reference to Article II, Section 2
%     would only show as Section II. A reference to Article III Section 1
%     would show as Article III Section 1.
\def\MakeCompactRefs{1}

%%% TODO
% * appendix
% * item refs
% * officers
% * n-subsec
% * @variables
% * constitution change annotation
% * paragraph page changes
% * hrule switch
% * margin switch

\usepackage[margin=1in]{geometry}
% fooders, headers
\usepackage{fancyhdr}
% reference for last page
\usepackage{lastpage}
% coloring text
\usepackage{xcolor}
% clickable references
\usepackage[destlabel=true]{hyperref}
% don't hyphenate text
\usepackage[none]{hyphenat}
% commands for changing section commands
\usepackage{titlesec}
\usepackage{setspace}
% specifications for enums and items
\usepackage[shortlabels]{enumitem}
% commands for changing table of contents
\usepackage[titles]{tocloft}

%% command specifications
% command parser
\usepackage{xparse}
% \xspace after commands
\usepackage{xspace}
% for loops
\usepackage{forloop}
% if and then
\usepackage{ifthen}
% various tools for commands
\usepackage{etoolbox}

%% importing other files (used for *-sections.aux referencing)
\usepackage{import}




\makeatletter

%%% Configuration variables
\@ifundefined{groupname}
{
    \PackageError{commands}{%
        Please specify groupname BEFORE importing commands.tex. For example, use:\MessageBreak
        \def\protect\groupname{[GROUP NAME HERE]}\MessageBreak
        \protect\input{commands.tex}}{}
    \def\groupname{[GROUP NAME HERE]}
}
{}
\let\@oldgroupname\groupname
\def\groupname{\@oldgroupname\xspace}

\@ifundefined{doctype}
{
    \def\doctype{Constitution}
}
{}


%%% geometry
\setlength{\headheight}{15pt}
% no paragraph indentation
\setlength{\parindent}{0cm}
% line spacing
\linespread{1.25}
\setlength{\cftbeforesecskip}{0pt}
% get rid of most \hbox errors
\tolerance=1
\emergencystretch=\maxdimen
\hyphenpenalty=10000
\hbadness=10000

%%% hyperlinks
\definecolor{linkblue}{rgb}{0.0, 0.53, 0.74}
\definecolor{urlred}{HTML}{FF1423}

\hypersetup{
    colorlinks = true,
    urlcolor = urlred,
    linkcolor = linkblue,
    pdftitle={\groupname \doctype},
    pdfauthor={\groupname},
    pdfnewwindow=true,
}

%%% itemize and enumerate
\setlist[itemize]{noitemsep, nolistsep, leftmargin=*, align=left}
\setlist[enumerate]{noitemsep, nolistsep, leftmargin=*, align=left}
\renewcommand{\labelenumii}{\alph{enumii}.}

%%% headers and footers
\fancypagestyle{firststyle}
{
    \fancyhf{}
    \fancyfoot[R]{Page \thepage\ of \pageref*{LastPage}}
    \renewcommand{\headrulewidth}{0pt} % removes horizontal header line
}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{\textsc{\groupname}}
\fancyfoot[R]{Page \thepage\ of \pageref*{LastPage}}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%% command redefinitions
\let\old@title\title
\renewcommand{\title}[1]{\old@title{\textsc{#1}}}

\let\old@section\section

% indicate when ToC is being made
\let\old@tableofcontents\tableofcontents
\def\@makingTOC{0}
\renewcommand{\tableofcontents}{%
    \def\@makingTOC{1}%
    \begin{spacing}{1}
        \old@tableofcontents
    \end{spacing}
    \def\@makingTOC{0}
}
\renewcommand{\contentsname}{\hfill\bfseries\Large \textsc{Contents}\hfill}

% force some style decisions on first page
\let\old@maketitle\maketitle
\renewcommand{\maketitle}{
    \old@maketitle
    % cheaty way to force firststyle to be used for first page
    \thispagestyle{firststyle}
    % ... and to put a line
    \hrule
}

% allow author and date to be multiline
\let\old@author\author
\renewcommand{\author}[1]{
    \old@author{%
        \parbox{\linewidth}{%
            \centering
            \begin{spacing}{1}
                #1
            \end{spacing}
        }
    }
}

\let\old@date\date
\renewcommand{\date}[1]{
    \old@date{%
        \parbox{\linewidth}{%
            \centering
            \begin{spacing}{1}
                #1
            \end{spacing}
        }
    }
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\newcommand{\moiralist}[1]{\href{https://groups.mit.edu/webmoira/list/#1}{#1@mit.edu}}
\newcommand{\mailmanlist}[1]{\href{https://mailman.mit.edu:444/mailman/admin/#1}{#1@mit.edu}}
\newcommand{\mailto}[1]{\href{mailto:#1}{#1}}

\newcommand{\officer}[1]{%
    \addcontentsline{toc}{\nextsecdepth}{#1}%
    \hyperref[officer:#1]{\textbf{#1}}%
    \label{officer:#1}%
}


\newcounter{arrays}
\setcounter{arrays}{1}

\newcommand{\makearr}[1]{%
    \newcounter{arrlen#1}%
    %
    \expandafter\edef\csname#1\endcsname{#1}%
    \stepcounter{arrays}%
}

\newcommand{\getlen}[1]{%
    \expandafter\csname thearrlen#1\endcsname%
}
\newcommand{\setidx}[3]{%
    % array: #1
    % idx: #2
    % value: #3
    \def\currentlimit{\the\numexpr\getlen{#1}\relax}%
    \ifnum#2>\currentlimit%
        \PackageError{commands}{Cannot set array index out of bounds}{}%
    \else%
        \expandafter\edef\csname arrval{#1}at{#2}\endcsname{#3}%
        %
        \ifnum#2=\currentlimit%
            \stepcounter{arrlen#1}%
        \fi%
    \fi%
}
\newcommand{\addidx}[2]{%
    \setidx{#1}{\getlen{#1}}{#2}%
}
\newcommand{\getidx}[2]{%
    \expandafter\csname arrval{#1}at{#2}\endcsname%
}
\NewDocumentCommand{\printarr}{m O{0} O{}}{
    \ifnum#2=\getlen{#1}%
        #3%
    \else%
        \edef\starttext{#1 [\getlen{#1}]: }%
        \ifstrempty{#3}{%
        }{%
            \edef\starttext{#3, }%
        }%
        \starttext\printarr{#1}[\the\numexpr1+#2\relax][idx #2: \getidx{#1}{#2}]%
    \fi%
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\makearr{sectionnames}
\makearr{sectionshorts}
\makearr{sectionlongs}
\makearr{sectionnumstyles}

\newcommand{\getdepth}[1]{%
    \expandafter\csname #1depth\endcsname%
}
\newcommand{\getindex}[1]{%
    \expandafter\csname #1index\endcsname%
}


\newcounter{copyarrcounter}
\newcommand{\copyarr}[2]{%
    % array to copy: #1
    % name to copy into: #2
    \expandafter\makearr{#2}%
    \forloop{copyarrcounter}{0}{\value{copyarrcounter} < \getlen{#1}}{%
        %\typeout{Attempting to copy #1 into #2}
        \expandafter\addidx\csname#2\endcsname{\getidx{#1}{\thecopyarrcounter}}%
    }%
}

\makearr{SectToTheoDepth}
\newcounter{sectiondepth}
\setcounter{sectiondepth}{-1}

\makearr{SectToSectType}
\makearr{SectToSectNum}



\newcounter{sectheadnameiter}
\newcounter{dummysectheadcounter}
\setcounter{dummysectheadcounter}{-1}%
\NewDocumentCommand{\sectheadname}{m m O{} O{0}}{%
    % #1:
    %    1 = full
    %    2 = short
    %    3 = ID
    % #2: step
    % #3: variable to encode into
    % #4: trim at start?
    \edef\returntext{??}%
    \edef\ThisDepth{\getidx\SectDepthsAtCount{#2}}%
    \edef\ThisSectToSectType{\expandafter\csname SectToSectTypeAtCount#2\endcsname}%
    \edef\ThisSectToSectNum{\expandafter\csname SectToSectNumAtCount#2\endcsname}%
    \edef\ThisSectionTotalsHistory{\expandafter\csname @sectionTotalsHistoryAtCount#2\endcsname}%
    %
    \edef\SectTreeAgree{0}%
    \ifnum#4=1%
        \edef\SectTreeAgree{1}%
    \fi%
    \setcounter{dummysectheadcounter}{0}%
    %
    \forloop{sectheadnameiter}{0}{\value{sectheadnameiter} < \the\numexpr1+\ThisDepth\relax}{%
        \edef\numbr{\getidx\ThisSectToSectNum{\thesectheadnameiter}}%
        \edef\currentnumbr{\getidx\SectToSectNum{\thesectheadnameiter}}%
        %
        \edef\secttypeID{\getidx\ThisSectToSectType{\thesectheadnameiter}}%
        \edef\indexofsecttype{\getindex{\secttypeID}}%
        %
        %
        \ifnum#4=1%
            \edef\@thisSectionTotal{\getidx\ThisSectionTotalsHistory{\indexofsecttype}}%
            \edef\@currentSectionTotal{\getidx\@sectionTotals{\indexofsecttype}}%
            %\typeout{\secttypeID ref at idx \indexofsecttype, current \@thisSectionTotal v. \@currentSectionTotal}
            \ifnum\@thisSectionTotal=\@currentSectionTotal%
            \else%
                \edef\SectTreeAgree{0}%
            \fi%
        \fi%
        %
        \ifnum\SectTreeAgree=0%
            \ifnum\thedummysectheadcounter>0%
                \ifnum#1=1%
                    \edef\returntext{\returntext, }%
                \else%
                    \ifnum#1=2%
                        \edef\returntext{\returntext\\}%
                    \else%
                        \edef\returntext{\returntext.}%
                    \fi%
                \fi%
            \else%
                \edef\returntext{}%
            \fi%
            %
            \let\seclist\sectionshorts%
            \def\secspec{.}%
            \ifnum#1=1%
                \let\seclist\sectionlongs%
                \def\secspec{ }%
            \fi%
            %
            \edef\secttypename{\getidx\seclist{\indexofsecttype}}%
            \edef\returntext{\returntext\secttypename\secspec\numbr}%
            %
            \stepcounter{dummysectheadcounter}%
        \fi%
    }%
    %
    \ifstrempty{#3}%
    {%
        \returntext%
    }%
    {%
        \expandafter\let\csname#3\endcsname\returntext%
    }%
    \setcounter{dummysectheadcounter}{-1}%
}
\NewDocumentCommand{\sectheadfullname}{m O{}}{%
    \sectheadname{1}{#1}[#2][\MakeCompactRefs]%
}
\NewDocumentCommand{\sectheadabbv}{O{}}{%
    \sectheadname{2}{\theheadercounter}[#1][0]%
}
\NewDocumentCommand{\sectheadid}{O{}}{%
    \sectheadname{3}{\theheadercounter}[#1][0]%
}


\newcounter{lastdepth}
\setcounter{lastdepth}{-1}

\edef\lastTheoDepth{-1}
\edef\lastIndex{-2}


\newcounter{headercounter}
\setcounter{headercounter}{-1}


\makearr{SectToSectTypeHistory}
\makearr{SectToSectNumHistory}
\makearr{SectDepthHistory}
\makearr{SectDepthsAtCount}

\makearr{@apriori@section@names}

\makearr{@sectionTotalsHistory}
\def\@madeSections{0}
\newcommand{\@makeFutureSection}[1]{
    \addidx\@apriori@section@names{#1}
    \addidx\@sectionTotalsHistory{0}

    \expandafter\edef\csname#1index\endcsname{\getlen{\sectionnames}}%
    \addidx\sectionnames{#1}%
    \def\@madeSections{1}
}

\newcounter{dummydummy}
\newcommand{\declareHeaderAtCount}[4]{%
    \typeout{Header info [#1]: #2.#3 at #4}
    % headercounter #1
    % SectType #2
    % SectNum #3
    % depth #4
    \setidx\SectToSectTypeHistory{#4}{#2}%
    \setidx\SectToSectNumHistory{#4}{#3}%
    %\addidx\
    %
    \copyarr\SectToSectTypeHistory{SectToSectTypeAtCount#1}%
    \copyarr\SectToSectNumHistory{SectToSectNumAtCount#1}%
    \setidx\SectDepthsAtCount{#1}{#4}%
    %
    \expandafter\let\expandafter\sectionIndex\csname#2index\endcsname
    \edef\oldtotal{\getidx\@sectionTotalsHistory{\sectionIndex}}
    \setidx\@sectionTotalsHistory{\sectionIndex}{\the\numexpr\oldtotal+1\relax}
    \copyarr\@sectionTotalsHistory{@sectionTotalsHistoryAtCount#1}%
}


\IfFileExists{\jobname-sections.aux}{
    \import{./}{\jobname-sections.aux}
}{}
\newwrite\SECTIONINFO
\immediate\openout\SECTIONINFO=\jobname-sections.aux

\makearr{@sectionTotals}
\NewDocumentCommand{\makesectioning}{ m m m m O{} }{
    % name: 1
    % short: 2
    % full: 3
    % number type: #4
    % depth: #5
    %
    \edef\nextdepth{\the\numexpr1+\thelastdepth\relax}%
    \ifstrempty{#5}{%
    }{%
        \edef\nextdepth{#5}%
    }%
    \expandafter\edef\csname #1depth\endcsname{\nextdepth}%
    \setcounter{lastdepth}{\nextdepth}%
    %
    \ifnum\@madeSections=0
        \expandafter\edef\csname#1index\endcsname{\getlen{\sectionnames}}%
    \fi
    \addidx\@sectionTotals{0}
    %
    %
    \let\commandname\RenewDocumentCommand
    \@ifundefined{#1}{
        \let\commandname\NewDocumentCommand
    }{}
    \ExpandArgs{c}\commandname{#1}{s m}{%
        \ifnum\@makingTOC=1
            \old@section*{##2}
        \else
            \edef\TheoDepth{\getdepth{#1}}%
            %
            \ifnum\thesectiondepth>-1
                \ifnum\TheoDepth>\the\numexpr1+\lastTheoDepth\relax
                    \PackageError{commands}{Cannot use #1, please use section headers sequentially}{}%
                \fi%
            \fi
            %
            \ifnum\lastIndex<\getindex{#1}%
                \stepcounter{sectiondepth}%
            \else%
                \edef\@newdepth{\the\numexpr\thesectiondepth+\getindex{#1}-\lastIndex}%
                \ifnum\@newdepth<0
                    \edef\@newdepth{0}
                \fi
                \setcounter{sectiondepth}{\@newdepth}
            \fi%
            %
            \edef\lastTheoDepth{\TheoDepth}
            \edef\lastIndex{\getindex{#1}}
            \setidx\SectToTheoDepth{\thesectiondepth}{\TheoDepth}%
            %
            \stepcounter{#1}%
            \setidx\SectToSectType{\thesectiondepth}{#1}%
            \setidx\SectToSectNum{\thesectiondepth}{#4{#1}}%
            %
            \def\oldtotal{\getidx\@sectionTotals{\csname#1index\endcsname}}
            \setidx\@sectionTotals{\csname#1index\endcsname}{\the\numexpr\oldtotal+1\relax}
            %
            \stepcounter{headercounter}%
            %
            \protected@write\SECTIONINFO{}{\string%
                \declareHeaderAtCount{\theheadercounter}{#1}{#4{#1}}{\thesectiondepth}%
            }
            %
            \def\spacingamount{\fpeval{1/(2^\TheoDepth)}}%
            \ifnum\thesectiondepth=0%
                \vspace{1cm}
                %\hrule
            \fi%
            \par%
            \vspace{\spacingamount cm}%
            %
            %%% TEXT HERE
            \phantomsection%
            \def\sectionstyling{DEFAULTSECTIONSTYLE}%
            \ifnum\thesectiondepth<\getlen{\SectionStyling}%
                \def\sectionstyling{\getidx\SectionStyling{\thesectiondepth}}%
            \fi%
            %
            \sectheadid[@sectheaddestlabel]%
            \hyperref[\@sectheaddestlabel]{\csname \sectionstyling\endcsname{\textsc{#3 #4{#1}. ##2}}}%
            %
            \reversemarginpar\marginpar[%
                \begin{spacing}{1}%
                    \scriptsize \sectheadabbv%
                \end{spacing}%
            ]{}%
            \edef\@currentlabel{\sectheadfullname{\theheadercounter}}%
            \label{\@sectheaddestlabel}%
            \par
            %
            \IfBooleanTF{##1}%
            {}%
            {%
                \ifnum\thesectiondepth<\getlen{\ToCDepths}%
                    \addcontentsline{toc}{\getidx\ToCDepths{\thesectiondepth}}{#3 #4{#1}. ##2}%
                \fi%
            }%
        \fi%
    }%
    %
    \ifnum\@madeSections=0
        \def\numsectypes{\getlen{\sectionnames}}%
    \else
        \expandafter\def\expandafter\numsectypes{\csname#1index\endcsname}
    \fi
    \@ifundefined{the#1}{
        \newcounter{#1}%
    }{
        \setcounter{#1}{0}
    }
    \ifnum\numsectypes>0%
        \edef\lastsecnum{\the\numexpr\numsectypes - 1\relax}%
        \counterwithin*{#1}{\getidx\sectionnames{\lastsecnum}}%
    \fi%
    %
    \ifnum\@madeSections=0
        \typeout{no made section!}
        \addidx\sectionnames{#1}%
    \else
        \typeout{section made!}
    \fi
    
    \addidx\sectionshorts{#2}%
    \addidx\sectionlongs{#3}%
    \expandafter\let\csname#1numstyle\endcsname#4
    \protected@write\SECTIONINFO{}{\string%
        \@makeFutureSection{#1}%
    }%
}

\makearr{ToCDepths}
\makearr{SectionStyling}

\addidx\ToCDepths{section}
\def\SECTIONSTYLE{\normalfont\Large\bfseries\underline}
\addidx\SectionStyling{SECTIONSTYLE}

\addidx\ToCDepths{subsection}
\def\SUBSECTIONSTYLE{\normalfont\large\bfseries}
\addidx\SectionStyling{SUBSECTIONSTYLE}

\addidx\ToCDepths{subsubsection}
\def\DEFAULTSECTIONSTYLE{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{paragraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}

\addidx\ToCDepths{subparagraph}
%\addidx\SectionStyling{\normalfont\normalsize\bfseries}



\let\appnum\Alph
\makesectioning{appendix}{APP}{Appendix}{\appnum}

\let\artnum\Roman
\makesectioning{article}{ART}{Article}{\artnum}[\thelastdepth]

\let\secnum\arabic
\makesectioning{section}{SEC}{Section}{\secnum}

\let\subnum\arabic
\makesectioning{subsection}{SUB}{Subsection}{\subnum}

\let\subsubnum\arabic
\makesectioning{subsubsection}{SUB$^2$}{Subsubsection}{\subsubnum}

\makeatother